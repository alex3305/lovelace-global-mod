---
name: Release

# yamllint disable-line rule:truthy
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: docker
    steps:
      - name: ‚§µÔ∏è Checkout Configuration
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 21

      - name: üèó Install dependencies
        run: npm ci

      - name: üöÄ Run dist
        run: npm run dist

      - name: ‚ú® Archive production artifacts
        uses: https://code.forgejo.org/forgejo/upload-artifact@v4
        with:
          path: |
            global-mod.js

  release:
    runs-on: docker
    steps:
      - name: ‚§µÔ∏è Checkout Configuration
        uses: actions/checkout@v4

      - name: ‚ú® Retrieve build artifacts
        uses: https://code.forgejo.org/forgejo/download-artifact@v4

      - name: üéØ Get version
        shell: bash
        run: |
          VERSION_TAG=$(jq -r .version package.json)
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV

      - name: üßæ Generate release notes
        shell: bash
        # yamllint disable rule:line-length
        run: |
          PREVIOUS=$(git describe --tags --abbrev=0)
          CURRENT=$(git rev-parse HEAD)
          (git log "$PREVIOUS^..$CURRENT" --format="- %h - %s (%an, %ar)" | sed '/Merge/d') > CHANGELOG.md
        # yamllint enable rule:line-length

      - name: üì¶ Move artifact to root
        run: mv artifact/global-mod.js global-mod.js

      - name: üó≥ Pack GitHub Release
        shell: bash
        run: |
          tar -cvzf global-mod-github.tar.gz \
              images/ \
              src/ \
              global-mod.js \
              hacs.json \
              LICENSE.md \
              package-lock.json \
              package.json \
              README.md

      - name: üöÄ Create release
        uses: akkuman/gitea-release-action@v1
        with:
          name: "v${{ env.VERSION_TAG }}"
          tag_name: "v${{ env.VERSION_TAG }}"
          body_path: CHANGELOG.md
          files: |
            global-mod.js
            global-mod-github.tar.gz

  increment-version:
    runs-on: docker
    steps:
      - name: ‚§µÔ∏è Checkout Configuration
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 21

      - name: ‚è´ Increment patch version
        run: |
          npm version patch -m "Bump to v%s"
          git push -f origin
        env:
          GIT_COMMITTER_NAME: Actions Bot
          GIT_COMMITTER_EMAIL: actions@1d.lol
