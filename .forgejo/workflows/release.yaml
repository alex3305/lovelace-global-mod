---
name: Release

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: docker
    steps:
      - name: ‚§µÔ∏è Checkout Configuration
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 21

      - name: üèó Install dependencies
        run: npm ci

      - name: üöÄ Run dist
        run: npm run dist

      - name: ‚ú® Archive production artifacts
        uses: https://code.forgejo.org/forgejo/upload-artifact@v4
        with:
          path: |
            global-mod.js

  release:
    runs-on: docker
    steps:
      - name: ‚§µÔ∏è Checkout Configuration
        uses: actions/checkout@v4

      - name: ‚ú® Retrieve build artifacts
        uses: https://code.forgejo.org/forgejo/download-artifact@v4

      - name: üéØ Get version
        shell: bash
        run: |
          VERSION_TAG=$(jq -r .version package.json)
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV

      - name: üßæ Generate release notes
        shell: bash
        # yamllint disable rule:line-length
        run: |
          PREVIOUS=$(git describe --tags --abbrev=0)
          CURRENT=$(git rev-parse HEAD)
          (git log "$PREVIOUS^..$CURRENT" --format="- %h - %s (%an, %ar)" | sed '/Merge/d') > CHANGELOG.md
        # yamllint enable rule:line-length

      - name: üöÄ Create release
        uses: akkuman/gitea-release-action@v1
        with:
          name: "v${{ env.VERSION_TAG }}"
          tag_name: "v${{ env.VERSION_TAG }}"
          body_path: CHANGELOG.md
          files: |
            $DIRECTORY/global-mod.js
        env:
          DIRECTORY: ${{ github.workspace }}/global-mod/artifact

      - name: üöÄ Create additional tags
        run: |
          MINOR_TAG="v${VERSION_TAG%.*}"
          MAJOR_TAG="v${VERSION_TAG%.*.*}"

          git tag -fa "$MINOR_TAG" -m "$MINOR_TAG"
          git tag -fa "$MAJOR_TAG" -m "$MAJOR_TAG"

          git push -f origin --tags
        env:
          GIT_COMMITTER_NAME: Actions Bot
          GIT_COMMITTER_EMAIL: actions@1d.lol

  increment-version:
    runs-on: docker
    steps:
      - name: ‚§µÔ∏è Checkout Configuration
        uses: actions/checkout@v4

      - name: üèó Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 21

      - name: Increment patch version
        run: |
          npm version patch -m "Bump to v%s"
          git push -f origin
        env:
          GIT_COMMITTER_NAME: Actions Bot
          GIT_COMMITTER_EMAIL: actions@1d.lol
